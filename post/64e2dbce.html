<!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta name="baidu-site-verification" content="hDU7MGKZcM"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="nqN9EwI9Vtq3CuJ37FtbIQ_4ufw6-aAGD8ERKGcyEbM"><meta name="baidu-site-verification" content="hDU7MGKZcM"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet"><link href="/css/main.css?v=5.1.4" rel="stylesheet"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="javascript,"><meta name="description" content="关于作用域请看另一篇文章：JavaScript 的作用域   上篇文章我们讲了作用域，知道JavaScript代码的整个执行过程，分为两个阶段，代码编译阶段与代码执行阶段。编译阶段由编译器完成，将代码翻译成可执行代码，这个阶段作用域规则会确定。执行阶段由引擎完成，主要任务是执行可执行代码，执行上下文在这个阶段创建。现在我们聊聊执行上下文。   执行上下文（Execution Context）执行上"><meta name="keywords" content="javascript"><meta property="og:type" content="article"><meta property="og:title" content="JavaScript 中的执行上下文、词法环境、变量环境"><meta property="og:url" content="http://www.luanzhuxian.com/post/64e2dbce.html"><meta property="og:site_name" content="栾铸显的博客"><meta property="og:description" content="关于作用域请看另一篇文章：JavaScript 的作用域   上篇文章我们讲了作用域，知道JavaScript代码的整个执行过程，分为两个阶段，代码编译阶段与代码执行阶段。编译阶段由编译器完成，将代码翻译成可执行代码，这个阶段作用域规则会确定。执行阶段由引擎完成，主要任务是执行可执行代码，执行上下文在这个阶段创建。现在我们聊聊执行上下文。   执行上下文（Execution Context）执行上"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://www.luanzhuxian.com/images/blog/environments/1.jpg"><meta property="og:image" content="http://www.luanzhuxian.com/images/blog/environments/data_structures.jpg"><meta property="og:image" content="http://www.luanzhuxian.com/images/blog/environments/2.jpg"><meta property="og:updated_time" content="2021-01-03T10:59:20.357Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="JavaScript 中的执行上下文、词法环境、变量环境"><meta name="twitter:description" content="关于作用域请看另一篇文章：JavaScript 的作用域   上篇文章我们讲了作用域，知道JavaScript代码的整个执行过程，分为两个阶段，代码编译阶段与代码执行阶段。编译阶段由编译器完成，将代码翻译成可执行代码，这个阶段作用域规则会确定。执行阶段由引擎完成，主要任务是执行可执行代码，执行上下文在这个阶段创建。现在我们聊聊执行上下文。   执行上下文（Execution Context）执行上"><meta name="twitter:image" content="http://www.luanzhuxian.com/images/blog/environments/1.jpg"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://www.luanzhuxian.com/post/64e2dbce.html"><title>JavaScript 中的执行上下文、词法环境、变量环境 | 栾铸显的博客</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">栾铸显的博客</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">No road to follow</h1></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><a href="https://github.com/luanzhuxian" style="display:none;position:absolute;top:3px;left:0;border:none"><img width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_left_gray_6d6d6d.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.luanzhuxian.com/post/64e2dbce.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content><meta itemprop="description" content><meta itemprop="image" content="/images/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="栾铸显的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">JavaScript 中的执行上下文、词法环境、变量环境</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-12T09:32:26+08:00">2019-05-12</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/javascript/" itemprop="url" rel="index"><span itemprop="name">javascript</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span><a href="/post/64e2dbce.html#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/post/64e2dbce.html" itemprop="commentCount"></span></a></span> <span id="/post/64e2dbce.html" class="leancloud_visitors" data-flag-title="JavaScript 中的执行上下文、词法环境、变量环境"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数&#58;</span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><p>关于作用域请看另一篇文章：<a href="https://www.luanzhuxian.com/post/cd6f8c2a.html">JavaScript 的作用域</a></p><p>上篇文章我们讲了作用域，知道<code>JavaScript</code>代码的整个执行过程，分为两个阶段，代码编译阶段与代码执行阶段。编译阶段由编译器完成，将代码翻译成可执行代码，这个阶段作用域规则会确定。执行阶段由引擎完成，主要任务是执行可执行代码，执行上下文在这个阶段创建。现在我们聊聊执行上下文。</p><h1 id="执行上下文（Execution-Context）"><a href="#执行上下文（Execution-Context）" class="headerlink" title="执行上下文（Execution Context）"></a>执行上下文（Execution Context）</h1><p>执行上下文是当前<code>JavaScript</code>代码被引擎解析和执行时所在环境的抽象概念。帮助<code>JavaScript</code>引擎管理整个解析和运行代码的复杂过程。在代码执行过程中，可能会出现多个执行上下文，但运行的执行上下文最多只有一个。为了管理执行上下文，我们引入了执行上下文栈，处于栈顶的那个元素就是运行的执行上下文。当解释器遇到函数、块语句、<code>try...catch</code>时，都会创建一个新的执行上下文后压入执行上下文栈，成为运行时执行上下文。</p><h2 id="执行上下文的种类"><a href="#执行上下文的种类" class="headerlink" title="执行上下文的种类"></a>执行上下文的种类</h2><p>分为全局执行上下文和函数执行上下文：</p><ul><li><strong>全局执行上下文</strong>：<code>Javascript</code>引擎首次开始解析代码时创建。只有一个。</li><li><strong>函数执行上下文</strong>：当一个函数被调用时，会创建一个活动记录（执行上下文），这个纪录会包含函数在哪里被调用（调用栈）、调用的方式、传入的参数等信息。<code>this</code>就是这个纪录的一个属性，会在函数执行的过程中用到。</li></ul><h2 id="执行上下文的结构"><a href="#执行上下文的结构" class="headerlink" title="执行上下文的结构"></a>执行上下文的结构</h2><p>包含<code>词法环境（Lexical Environment）</code>，<code>变量环境（Variable Environment）</code>和<code>this</code>的值。<br>An execution context has the following fields:<br>Environments: LexicalEnvironment and VariableEnvironment are what keep track of variables during runtime. Two references to environments. Both are usually the same.</p><ul><li><strong>LexicalEnvironment</strong>: resolve identifiers.（保存通过<code>let</code>、<code>const</code>、<code>with()</code>、<code>try-catch</code>创建的变量）</li><li><strong>VariableEnvironment</strong>: hold bindings made by variable declarations and function declarations.（保存通过<code>var</code>声明或<code>function(){}</code>声明的变量）</li><li><strong>ThisBinding</strong>: the current value of this.</li></ul><h2 id="执行上下文的抽象"><a href="#执行上下文的抽象" class="headerlink" title="执行上下文的抽象"></a>执行上下文的抽象</h2><p>我们将执行上下文抽象成伪代码，如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ExecutionContext = &#123;</span><br><span class="line">  ThisBinding = &lt;this value&gt;,     // 确定this</span><br><span class="line">  LexicalEnvironment = &#123; ... &#125;,   // 词法环境</span><br><span class="line">  VariableEnvironment = &#123; ... &#125;,  // 变量环境</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>词法环境和变量环境又是什么？</p><h1 id="环境（Environments）"><a href="#环境（Environments）" class="headerlink" title="环境（Environments）"></a>环境（Environments）</h1><p>我们看看 ECMAScript 5 中对<code>Environments</code>和<code>Execution Contexts</code>的解释：</p><blockquote bgcolor="#FF4500" style="margin-bottom:30px"><strong>Lexical environments</strong> hold variables and parameters. The currently active environment is managed via a stack of execution contexts (which grows and shrinks in sync with the call stack). Nested scopes are handled by chaining environments: each environment points to its outer environment (whose scope surrounds its scope). In order to enable lexical scoping, functions remember the scope (=environment) they were defined in. When a function is invoked, a new environment is created for it’s arguments and local variables. That environment’s outer environment is the function’s scope.</blockquote><p>由此可知<code>环境</code>其实就是<code>作用域</code>。在规范中<code>作用域</code>更官方的叫法是<code>词法环境</code>，<code>词法环境</code>是<code>作用域</code>的内部实现机制。<code>环境</code>外部还有<code>环境</code>，形成链条，也就是<code>作用域链</code>。当函数被调用时，会创建新的执行上下文、确定<code>this</code>指向和<code>环境</code>，引擎会在<code>环境</code>中查找参数和变量等标识符。也就是说随着执行栈的变化，随着执行函数的变化，当前的<code>环境</code>即<code>作用域</code>也是变化的，只是<code>环境</code>是函数定义时确定的，<code>this</code>是函数执行时确定的。看一个例子：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function foo () &#123;</span><br><span class="line">    console.log(color)</span><br><span class="line">&#125;</span><br><span class="line">function bar () &#123;</span><br><span class="line">    const color = &apos;yellow&apos;</span><br><span class="line">    foo()</span><br><span class="line">&#125;</span><br><span class="line">bar()   // color is not defined</span><br></pre></td></tr></table></figure><p>当<code>foo</code>执行时，创建新的上下文并入栈，<code>this</code>指向<code>window</code>，词法环境无标识符，外部环境是全局环境。引擎在当前<code>词法环境/作用域</code>找不到<code>color</code>，沿着作用域链，外部环境是<code>foo</code>定义时的外部<code>全局环境/全局作用域</code>，而不是调用时的外部<code>bar的作用域</code>，对<code>bar的作用域</code>无访问权限，所以外部也找不到，就会报错。</p><h1 id="词法环境（Lexical-Environment）"><a href="#词法环境（Lexical-Environment）" class="headerlink" title="词法环境（Lexical Environment）"></a>词法环境（Lexical Environment）</h1><h2 id="词法环境的种类"><a href="#词法环境的种类" class="headerlink" title="词法环境的种类"></a>词法环境的种类</h2><p>词法环境有三种类型：</p><ul><li><strong>全局环境（Global Environment）</strong>：是一个没有外部环境的词法环境，其外部环境引用为<code>null</code>。拥有一个全局对象（<code>window</code>对象）及其关联的方法和属性（例如数组方法）以及任何用户自定义的全局变量，<code>this</code>的值指向这个全局对象。</li><li><strong>函数环境（Function Environment）</strong>：用户在函数中定义的变量被存储在环境记录中，包含了<code>arguments</code>对象。其外部环境可以是全局环境，也可以是包含内部函数的外部函数环境。</li><li><strong>模块环境（Module Environment）</strong>：每个模块有自己的词法环境，存储了包括<code>imports</code>在内的所有的<code>top-level declarations</code>。其外部环境引用为全局环境。</li></ul><p><img src="/images/blog/environments/1.jpg" alt="avatar"></p><h2 id="词法环境的结构"><a href="#词法环境的结构" class="headerlink" title="词法环境的结构"></a>词法环境的结构</h2><p><img src="/images/blog/environments/data_structures.jpg" alt="avatar"></p><p>词法环境由两部分组成：一个<code>Environment Record</code>，还有一个指向外层<code>Lexical Environment</code>的可空引用。</p><ul><li><strong>环境记录（Environment Record）：</strong>An environment record maps identifiers to value. that maps variable names to variable values. This is where JavaScript stores variables. One key-value entry in the environment record is called a binding. 环境记录就是存储当前环境下的标识符-变量<code>key-value</code>的映射，存储变量、函数声明的实际位置。它分为三类：<ul><li><strong>Declarative Environment Record：</strong>store the effects of variable declarations, and function declarations.</li><li><strong>Object Environment Record：</strong>are used by the with statement and for the global environment. They turn an object into an environment. For with, that is the argument of the statement. For the global environment, that is the global object.</li><li><strong>Global Environment Record</strong></li></ul></li><li><strong>对外部环境的引用：</strong>A reference to the outer environment (null in the global environment) - the environment representing the outer scope of the scope represented by the current environment. 可以访问其外部词法环境。</li></ul><p>其中<code>Declarative Environment Record</code>又可分为两类：<code>Function Environment Records</code>函数环境记录和<code>Module Environment Records</code>模块环境记录。<br><img src="/images/blog/environments/2.jpg" alt="avatar"></p><h2 id="词法环境的抽象"><a href="#词法环境的抽象" class="headerlink" title="词法环境的抽象"></a>词法环境的抽象</h2><p>我们将词法环境（即作用域）抽象成伪代码，如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GlobalExectionContext = &#123;       // 全局执行上下文</span><br><span class="line">  LexicalEnvironment: &#123;    	  // 词法环境</span><br><span class="line">    EnvironmentRecord: &#123;        // 环境记录</span><br><span class="line">      Type: &quot;Object&quot;,      	  // 全局环境</span><br><span class="line">      outer: &lt;null&gt;  	   		  // 对外部环境的引用</span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FunctionExectionContext = &#123;      // 函数执行上下文</span><br><span class="line">  LexicalEnvironment: &#123;  	       // 词法环境</span><br><span class="line">    EnvironmentRecord: &#123;  	   // 环境记录</span><br><span class="line">      Type: &quot;Declarative&quot;,  	   // 函数环境</span><br><span class="line">      outer: &lt;Global or outer function environment reference&gt;  // 对外部环境的引用</span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h1 id="变量环境（Variable-Environment）"><a href="#变量环境（Variable-Environment）" class="headerlink" title="变量环境（Variable Environment）"></a>变量环境（Variable Environment）</h1><p>变量环境也是一个词法环境，<code>variable environment is a certain type of lexical environment</code>，因此它具有上面定义的词法环境的所有属性。<br><code>词法环境</code>和<code>变量环境</code>的区别在于前者用于存储<code>函数声明和变量（let const）</code>绑定，而后者仅用于存储<code>变量（var）</code>绑定。函数声明存储在<code>变量环境</code>中，而函数表达式存储在<code>词法环境</code>中。当遇到<code>with</code>和<code>catch</code>语句时，语句内部声明的变量是存储在外层词法环境中的，而外层的变量环境保持不变，当语句被销毁时，外层词法环境恢复。</p><p>例子：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">let a = 20</span><br><span class="line">const b = 30</span><br><span class="line">var c</span><br><span class="line"></span><br><span class="line">function multiply(e, f) &#123;  </span><br><span class="line"> var g = 20</span><br><span class="line"> return e * f * g;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c = multiply(20, 30)</span><br></pre></td></tr></table></figure><p></p><p>执行上下文如下所示：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">// 全局执行上下文</span><br><span class="line">GlobalExectionContext = &#123;</span><br><span class="line"></span><br><span class="line">  ThisBinding: &lt;Global Object&gt;,</span><br><span class="line"></span><br><span class="line">  // 词法环境</span><br><span class="line">  LexicalEnvironment: &#123;  </span><br><span class="line">    EnvironmentRecord: &#123;  </span><br><span class="line">      Type: &quot;Object&quot;,</span><br><span class="line">      a: &lt; uninitialized &gt;,</span><br><span class="line">      b: &lt; uninitialized &gt;,</span><br><span class="line">      multiply: &lt; func &gt;</span><br><span class="line">    &#125;  </span><br><span class="line">    outer: &lt;null&gt;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  // 变量环境</span><br><span class="line">  VariableEnvironment: &#123;  </span><br><span class="line">    EnvironmentRecord: &#123;  </span><br><span class="line">      Type: &quot;Object&quot;,</span><br><span class="line">      c: undefined</span><br><span class="line">    &#125;  </span><br><span class="line">    outer: &lt;null&gt;</span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 函数执行上下文，函数被调用的时候才会被创建</span><br><span class="line">FunctionExectionContext = &#123;  </span><br><span class="line"></span><br><span class="line">  ThisBinding: &lt;Global Object&gt;,</span><br><span class="line"></span><br><span class="line">  LexicalEnvironment: &#123;  </span><br><span class="line">    EnvironmentRecord: &#123;  </span><br><span class="line">      Type: &quot;Declarative&quot;,</span><br><span class="line">      Arguments: &#123;0: 20, 1: 30, length: 2&#125;</span><br><span class="line">    &#125;,  </span><br><span class="line">    outer: &lt;GlobalLexicalEnvironment&gt;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  VariableEnvironment: &#123;  </span><br><span class="line">    EnvironmentRecord: &#123;  </span><br><span class="line">      Type: &quot;Declarative&quot;,</span><br><span class="line">      g: undefined</span><br><span class="line">    &#125;,  </span><br><span class="line">    outer: &lt;GlobalLexicalEnvironment&gt;</span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="创建上下文时确定-this-的值（This-Binding）"><a href="#创建上下文时确定-this-的值（This-Binding）" class="headerlink" title="创建上下文时确定 this 的值（This Binding）"></a>创建上下文时确定 this 的值（This Binding）</h2><ul><li>全局执行上下文中，this 的值指向全局对象。</li><li>函数执行上下文中，this 的值取决于函数的调用方式。具体有：默认绑定、隐式绑定、显式绑定、new 绑定、箭头函数。</li></ul><h2 id="Record-和-Field"><a href="#Record-和-Field" class="headerlink" title="Record 和 Field"></a>Record 和 Field</h2><p>ES6 中将键值对的数据结构称为<code>Record</code>，其中的每一组键值对称为<code>field</code>。这就是说，一个 <code>Record</code>由多个<code>field</code>组成，而每个<code>field</code>都包含一对<code>key-value</code>。可以将<code>Record</code>看做一个对象<code>{}</code>。</p><h2 id="Identifier-Binding"><a href="#Identifier-Binding" class="headerlink" title="Identifier Binding"></a>Identifier Binding</h2><p>标识符绑定，将一个标识符和对应的值（数字、函数、对象等）绑定在一起。通俗说就是将值赋值给标识符。</p><h2 id="Identifier-Resolver"><a href="#Identifier-Resolver" class="headerlink" title="Identifier Resolver"></a>Identifier Resolver</h2><p>标识符解析，指在运行的执行上下文中的词法环境里，通过标识符获得其对应绑定的过程。这一过程和原型链查找类似。通俗说就是获取标识符的值。</p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/javascript/" rel="tag"># javascript</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/post/cd6f8c2a.html" rel="next" title="JavaScript 的作用域"><i class="fa fa-chevron-left"></i> JavaScript 的作用域</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/post/767a45e1.html" rel="prev" title="JavaScript 中的执行栈、执行上下文">JavaScript 中的执行栈、执行上下文<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt><p class="site-author-name" itemprop="name"></p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">36</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">11</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">11</span> <span class="site-state-item-name">标签</span></a></div></nav><embed style="margin-top:50px" autostart src="https://www.xiami.com/widget/5411220_832495252_235_346_cccccc_dddddd_1/collectPlayer.swf" type="application/x-shockwave-flash" width="235" height="346" wmode="opaque"></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#执行上下文（Execution-Context）"><span class="nav-number">1.</span> <span class="nav-text">执行上下文（Execution Context）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#执行上下文的种类"><span class="nav-number">1.1.</span> <span class="nav-text">执行上下文的种类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#执行上下文的结构"><span class="nav-number">1.2.</span> <span class="nav-text">执行上下文的结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#执行上下文的抽象"><span class="nav-number">1.3.</span> <span class="nav-text">执行上下文的抽象</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#环境（Environments）"><span class="nav-number">2.</span> <span class="nav-text">环境（Environments）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#词法环境（Lexical-Environment）"><span class="nav-number">3.</span> <span class="nav-text">词法环境（Lexical Environment）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#词法环境的种类"><span class="nav-number">3.1.</span> <span class="nav-text">词法环境的种类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#词法环境的结构"><span class="nav-number">3.2.</span> <span class="nav-text">词法环境的结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#词法环境的抽象"><span class="nav-number">3.3.</span> <span class="nav-text">词法环境的抽象</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#变量环境（Variable-Environment）"><span class="nav-number">4.</span> <span class="nav-text">变量环境（Variable Environment）</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#附录"><span class="nav-number">5.</span> <span class="nav-text">附录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建上下文时确定-this-的值（This-Binding）"><span class="nav-number">5.1.</span> <span class="nav-text">创建上下文时确定 this 的值（This Binding）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Record-和-Field"><span class="nav-number">5.2.</span> <span class="nav-text">Record 和 Field</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Identifier-Binding"><span class="nav-number">5.3.</span> <span class="nav-text">Identifier Binding</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Identifier-Resolver"><span class="nav-number">5.4.</span> <span class="nav-text">Identifier Resolver</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa fa-envira"></i></span> <span class="author" itemprop="copyrightHolder">lzx</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script src="/js/src/utils.js?v=5.1.4"></script><script src="/js/src/motion.js?v=5.1.4"></script><script src="/js/src/scrollspy.js?v=5.1.4"></script><script src="/js/src/post-details.js?v=5.1.4"></script><script src="/js/src/bootstrap.js?v=5.1.4"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: true,
        notify: true,
        appId: 'xscfkohc1AtS7Px8SMRn4SeR-gzGzoHsz',
        appKey: 'qODRtEtDSVo4Mxj6DkhVAqd9',
        placeholder: '留下点什么吧~',
        avatar:'',
        guest_info:guest,
        pageSize:'15' || 10,
        avatar_cdn:'https://www.gravatar.com/avatar/',
    });</script><script>// Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });</script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("xscfkohc1AtS7Px8SMRn4SeR-gzGzoHsz","qODRtEtDSVo4Mxj6DkhVAqd9")</script><script>function showTime(e){var t=new AV.Query(e),c=[],u=$(".leancloud_visitors");u.each(function(){c.push($(this).attr("id").trim())}),t.containedIn("url",c),t.find().done(function(e){var t=".leancloud-visitors-count";if(0!==e.length){for(var n=0;n<e.length;n++){var o=e[n],i=o.get("url"),s=o.get("time"),r=document.getElementById(i);$(r).find(t).text(s)}for(n=0;n<c.length;n++){i=c[n],r=document.getElementById(i);var l=$(r).find(t);""==l.text()&&l.text(0)}}else u.find(t).text(0)}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(i){var e=$(".leancloud_visitors"),s=e.attr("id").trim(),r=e.attr("data-flag-title").trim(),t=new AV.Query(i);t.equalTo("url",s),t.find({success:function(e){if(0<e.length){var t=e[0];t.fetchWhenSave(!0),t.increment("time"),t.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var n=new i,o=new AV.ACL;o.setPublicReadAccess(!0),o.setPublicWriteAccess(!0),n.setACL(o),n.set("title",r),n.set("url",s),n.set("time",1),n.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):1<$(".post-title-link").length&&showTime(e)})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script></body></html>